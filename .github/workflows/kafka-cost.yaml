name: build
on:
  push:
    paths:
      - "flake.*"
      - "**.nix"
      - "kafka-cost/**"

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build kafka-cost
    permissions:
      packages: "write"
      contents: "read"
      id-token: "write"
    steps:
      - name: nix-build
        uses: nais/nais-nix-action@main
        id: nix-build
        with:
          team: nais
          identity_provider: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }}
          project_id: ${{ vars.NAIS_MANAGEMENT_PROJECT_ID }}
          debug: true
    outputs:
      image: ${{ steps.nix-build.outputs.image }}

  deploy_kafka-cost:
    name: Deploy kafka-cost
    if: github.ref == 'refs/heads/main'
    runs-on: [fasit-deploy]
    needs: [build]
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download spec
        uses: actions/download-artifact@v4
        with:
          name: spec.yaml
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.NAIS_IO_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: gh-aiven-cost@nais-io.iam.gserviceaccount.com
          token_format: access_token
      - name: Get credentials
        shell: bash
        run: |
          gcloud container clusters get-credentials nais-io --project nais-io --region europe-north1
      - name: deploy aiven-cost
        shell: bash
        run: |
         kubectl apply -f spec.yaml
